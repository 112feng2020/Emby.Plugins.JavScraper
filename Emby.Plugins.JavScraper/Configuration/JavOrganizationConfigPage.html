﻿
<!DOCTYPE html>
<html>
<head>
    <title>JavOrganize 配置</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage JavOrganizeConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton,emby-collapse">
        <div data-role="content">
            <div class="content-primary">

                <div class="verticalSection verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">JavOrganize 配置</h2><span id="current_version" name="current_version" is="emby-linkbutton" class="emby-button"></span>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank" href="https://javscraper.com/">帮助</a>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank" href="https://github.com/JavScraper/Emby.Plugins.JavScraper">源码</a>
                    </div>
                </div>

                <div class="readOnlyContent">
                    <p class="description1">
                        重新组织日本电影的文件结构。
                        <a is="emby-linkbutton" target="_blank" href="https://javscraper.com/" class="button-link emby-button">了解更多</a>
                    </p>
                </div>

                <form class="JavOrganizeConfigurationForm">

                    <div>
                        <label class="checkboxContainer">
                            <input type="checkbox" is="emby-checkbox" id="chkEnableMovieSorting" />
                            <span>Enable auto-organize for movies</span>
                        </label>
                    </div>
                    <div class="inputContainer">
                        <div style="display:flex; align-items:center;">
                            <div style="flex-grow:1;">
                                <input is="emby-input" id="txtWatchMovieFolder" type="text" label="Watch folder:" />
                                <div class="fieldDescription">This folder will be monitored for new movies.</div>
                            </div>
                            <button type="button" is="paper-icon-button-light" id="btnSelectWatchMovieFolder" title="Select directory" class="autoSize"><i class="md-icon">search</i></button>
                        </div>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" id="txtMovieMinFileSize" type="number" label="Min file size:" pattern="[0-9]*" min="0" required />
                        <div class="fieldDescription">Files smaller than this will be ignored.</div>
                    </div>

                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="chkSubMovieFolders" />
                            <span>Create subdirectory per Movie</span>
                        </label>
                    </div>

                    <div is="emby-collapse" class="hide fldSelectMovieFolderPattern" title="Movie folder pattern">
                        <div class="collapseContent">
                            <br />
                            <div class="inputContainer">
                                <input is="emby-input" id="txtMovieFolderPattern" type="text" label="Movie folder pattern:" required />
                                <div class="fieldDescription movieFolderPatternDescription"></div>
                            </div>

                            <br />
                            <p>Supported Patterns</p>

                            <table id="movie-table" class="ui-responsive">
                                <thead>
                                    <tr>
                                        <th>Term</th>
                                        <th>Pattern</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%mn</td>
                                        <td>Movie name</td>
                                    </tr>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%m.n</td>
                                        <td>Movie.name</td>
                                    </tr>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%m_n</td>
                                        <td>Movie_name</td>
                                    </tr>
                                    <tr>
                                        <td>Production year</td>
                                        <td>%my</td>
                                        <td>2017</td>
                                    </tr>
                                    <tr>
                                        <td>File extension</td>
                                        <td>%ext</td>
                                        <td>mkv</td>
                                    </tr>
                                    <tr>
                                        <td>Original File Name</td>
                                        <td>%fn</td>
                                        <td>filename</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div is="emby-collapse" title="Movie file pattern">
                        <div class="collapseContent">
                            <br />
                            <div class="inputContainer">
                                <input is="emby-input" id="txtMoviePattern" type="text" label="Movie pattern:" required />
                                <div class="fieldDescription moviePatternDescription"></div>
                            </div>

                            <br />
                            <p>Supported Patterns</p>

                            <table id="movie-table" class="ui-responsive">
                                <thead>
                                    <tr>
                                        <th>Term</th>
                                        <th>Pattern</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%mn</td>
                                        <td>Movie name</td>
                                    </tr>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%m.n</td>
                                        <td>Movie.name</td>
                                    </tr>
                                    <tr>
                                        <td>Movie name</td>
                                        <td>%m_n</td>
                                        <td>Movie_name</td>
                                    </tr>
                                    <tr>
                                        <td>Production year</td>
                                        <td>%my</td>
                                        <td>2017</td>
                                    </tr>
                                    <tr>
                                        <td>File extension</td>
                                        <td>%ext</td>
                                        <td>mkv</td>
                                    </tr>
                                    <tr>
                                        <td>Original File Name</td>
                                        <td>%fn</td>
                                        <td>filename</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <br /><br />
                    <div class="selectContainer">
                        <select is="emby-select" id="copyOrMoveMovieFile" label="Transfer method:">
                            <option value="true">Copy</option>
                            <option value="false">Move</option>
                        </select>
                        <div class="fieldDescription editorfieldDescription">Copy or move files from the watch folder</div>
                    </div>
                    <div>
                        <label class="checkboxContainer">
                            <input type="checkbox" is="emby-checkbox" id="chkOverwriteExistingMovies" />
                            <span>Overwrite existing movies</span>
                        </label>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" id="txtDeleteLeftOverMovieFiles" type="text" label="Delete left over files" />
                        <div class="fieldDescription">Each value separated by ;</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="chkDeleteEmptyMovieFolders" />
                            <span>Delete empty folders</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">Empty folders will be deleted</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="chkExtendedClean" />
                            <span>Extended Clean</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">Extended clean of left over files and empty folders</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="chkEnableMovieAutoDetect" />
                            <span>Enable auto-detect for movies</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">Warning Beta feature, Use with caution, this may cause significantly longer scans and false identification</div>
                    </div>
                    <div class="fldSelectMovieFolder hide selectContainer">
                        <select id="selectMovieFolder" is="emby-select" label="Default Movie library:"></select>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">

            var JavOrganizeConfigurationPage = {
                pluginUniqueId: "0f34b81a-4af7-4719-9958-4cb8f680e7c6"
            };

            $('.JavOrganizeConfigurationPage').on('pageshow', function (event) {
                Dashboard.showLoadingMsg();
                var view = this;
                ApiClient.getPluginConfiguration(JavOrganizeConfigurationPage.pluginUniqueId).then(function (config) {
                    $('#current_version', view).text("v" + config.Version);

                    var movieOptions = config.JavOrganizationOptions;

                    view.querySelector('#chkEnableMovieSorting').checked = movieOptions.IsEnabled;
                    view.querySelector('#chkOverwriteExistingMovies').checked = movieOptions.OverwriteExistingFiles;
                    view.querySelector('#chkDeleteEmptyMovieFolders').checked = movieOptions.DeleteEmptyFolders;

                    view.querySelector('#txtMovieMinFileSize').value = movieOptions.MinFileSizeMb;
                    view.querySelector('#txtMoviePattern').value = movieOptions.MoviePattern;
                    view.querySelector('#txtWatchMovieFolder').value = movieOptions.WatchLocations[0] || '';

                    view.querySelector('#chkSubMovieFolders').checked = movieOptions.MovieFolder;
                    view.querySelector('#txtMovieFolderPattern').value = movieOptions.MovieFolderPattern;

                    view.querySelector('#txtDeleteLeftOverMovieFiles').value = movieOptions.LeftOverFileExtensionsToDelete.join(';');

                    view.querySelector('#chkExtendedClean').checked = movieOptions.ExtendedClean;

                    view.querySelector('#chkEnableMovieAutoDetect').checked = movieOptions.AutoDetectMovie;

                    view.querySelector('#copyOrMoveMovieFile').value = movieOptions.CopyOriginalFile.toString();

                    Dashboard.hideLoadingMsg();
                });
            });

            $('.JavOrganizeConfigurationForm').on('submit', function (e) {
                Dashboard.showLoadingMsg();
                var view = this;
                ApiClient.getPluginConfiguration(JavOrganizeConfigurationPage.pluginUniqueId).then(function (config) {

                    var movieOptions = config.JavOrganizationOptions;

                    movieOptions.IsEnabled = view.querySelector('#chkEnableMovieSorting').checked;
                    movieOptions.OverwriteExistingFiles = view.querySelector('#chkOverwriteExistingMovies').checked;
                    movieOptions.DeleteEmptyFolders = view.querySelector('#chkDeleteEmptyMovieFolders').checked;

                    movieOptions.MinFileSizeMb = view.querySelector('#txtMovieMinFileSize').value;
                    movieOptions.MoviePattern = view.querySelector('#txtMoviePattern').value;
                    movieOptions.LeftOverFileExtensionsToDelete = view.querySelector('#txtDeleteLeftOverMovieFiles').value.split(';');

                    movieOptions.ExtendedClean = view.querySelector('#chkExtendedClean').checked;

                    movieOptions.AutoDetectMovie = view.querySelector('#chkEnableMovieAutoDetect').checked;
                    movieOptions.DefaultMovieLibraryPath = view.querySelector('#selectMovieFolder').value;

                    movieOptions.MovieFolder = view.querySelector('#chkSubMovieFolders').checked;
                    movieOptions.MovieFolderPattern = view.querySelector('#txtMovieFolderPattern').value;

                    var watchLocation = view.querySelector('#txtWatchMovieFolder').value;
                    movieOptions.WatchLocations = watchLocation ? [watchLocation] : [];

                    movieOptions.CopyOriginalFile = view.querySelector('#copyOrMoveMovieFile').value;

                    ApiClient.updatePluginConfiguration(JavOrganizeConfigurationPage.pluginUniqueId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });
                // Disable default form submission
                return false;
            });

            //$(document).ready(function () {
            //    $(document).on('click', '#btnSelectWatchMovieFolder', selectWatchFolder);
            //});
            $('#btnSelectWatchMovieFolder').on('click', function (e) {
                var view = this.parentElement;
                require(['directorybrowser'], function (directoryBrowser) {
                    var picker = new directoryBrowser();
                    picker.show({

                        callback: function (path) {

                            if (path) {
                                view.querySelector('#txtWatchMovieFolder').value = path;
                            }
                            picker.close();
                        },
                        header: 'Select Watch Folder',
                        validateWriteable: true
                    });
                });
            });
        </script>
    </div>
</body>
</html>